<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Lease Management Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding-top: 20px;
      font-size: 14px;
    }
    
    /* Card styles */
    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
      border-radius: 10px;
    }
    
    .card-header {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      color: white;
      font-weight: 600;
      border-radius: 10px 10px 0 0;
      padding: 15px 20px;
    }
    
    /* Lease status badges */
    .lease-status-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 15px;
      font-weight: 500;
    }
    
    .lease-expired { 
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }
    
    .lease-expiring { 
      background: linear-gradient(135deg, #fd7e14, #e55100);
      color: white;
    }
    
    .lease-active { 
      background: linear-gradient(135deg, #198754, #157347);
      color: white;
    }
    
    .lease-grace { 
      background: linear-gradient(135deg, #ffc107, #ffb302);
      color: #000;
    }
    
    /* Stats cards */
    .stats-card {
      border-left: 4px solid #0d6efd;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stats-card.danger {
      border-left-color: #dc3545;
    }
    
    .stats-card.warning {
      border-left-color: #ffc107;
    }
    
    .stats-card.success {
      border-left-color: #198754;
    }
    
    .stats-card .card-body {
      padding: 1.5rem;
    }
    
    .stats-card h3 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }
    
    /* Client row styles */
    .client-row {
      transition: background-color 0.2s;
    }
    
    .client-row:hover {
      background-color: #f1f5f9;
    }
    
    /* Copyable elements */
    .copyable {
      cursor: pointer;
      transition: all 0.2s;
      padding: 0.25rem;
      border-radius: 4px;
    }
    
    .copyable:hover {
      background-color: #e9ecef;
      color: #0d6efd;
    }
    
    /* Token display */
    .token-display {
      word-break: break-all;
      font-family: 'Courier New', monospace;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ced4da;
      margin-top: 10px;
      font-size: 0.85rem;
      max-height: 150px;
      overflow-y: auto;
    }
    
    /* Loading states */
    .loading {
      display: none;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    
    /* Lease actions */
    .lease-actions {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    
    .lease-actions .btn {
      flex: 0 0 auto;
    }
    
    /* Progress bars */
    .progress-days {
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }
    
    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .progress-fill.active { 
      background: linear-gradient(90deg, #198754, #20c997);
    }
    
    .progress-fill.expiring { 
      background: linear-gradient(90deg, #fd7e14, #ff8f00);
    }
    
    .progress-fill.expired { 
      background: linear-gradient(90deg, #dc3545, #c82333);
    }
    
    /* Enhanced form styles */
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* Enhanced button styles */
    .btn {
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      border: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #198754, #157347);
      border: none;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #ffb302);
      border: none;
      color: #000;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      border: none;
    }
    
    /* Spinner improvements */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Alert styles */
    .alert {
      border: none;
      border-radius: 8px;
      font-weight: 500;
    }
    
    /* Page header */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .page-header h1 {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    /* Search and filter improvements */
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Action button improvements */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    
    /* Toast notifications positioning */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
      <h1><i class="bi bi-calendar-check"></i> Chatbot Lease Management Dashboard</h1>
    </div>

    <!-- Lease Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card success">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Active Leases</h6>
                <h3 class="mb-0" id="active-leases-count">-</h3>
              </div>
              <div class="text-success">
                <i class="bi bi-check-circle-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card warning">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Expiring Soon</h6>
                <h3 class="mb-0" id="expiring-soon-count">-</h3>
              </div>
              <div class="text-warning">
                <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card danger">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Expired</h6>
                <h3 class="mb-0" id="expired-count">-</h3>
              </div>
              <div class="text-danger">
                <i class="bi bi-x-circle-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Total Clients</h6>
                <h3 class="mb-0" id="total-clients-count">-</h3>
              </div>
              <div class="text-primary">
                <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Create New Client -->
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-person-plus"></i> Create New Client
          </div>
          <div class="card-body">
            <form id="create-client-form">
              <div class="mb-3">
                <label for="client-name" class="form-label">Client Name</label>
                <input type="text" class="form-control" id="client-name" required>
              </div>
              <div class="mb-3">
                <label for="client-email" class="form-label">Client Email</label>
                <input type="email" class="form-control" id="client-email" required>
              </div>
              <div class="mb-3">
                <label for="lease-duration" class="form-label">Lease Duration</label>
                <select class="form-select" id="lease-duration" required>
                  <option value="7">7 Days</option>
                  <option value="14">14 Days</option>
                  <option value="30" selected>30 Days</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="allowed-domains" class="form-label">Allowed Domains</label>
                <input type="text" class="form-control" id="allowed-domains" 
                       placeholder="example.com, client-site.org">
                <div class="form-text">Leave empty to allow all domains</div>
              </div>
              <button type="submit" class="btn btn-success w-100">
                <span class="spinner-border spinner-border-sm d-none" id="create-spinner"></span>
                <i class="bi bi-plus-circle"></i> Create Client
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Generate Token -->
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-key"></i> Generate Token
          </div>
          <div class="card-body">
            <form id="generate-token-form">
              <div class="mb-3">
                <label for="token-client-id" class="form-label">Client ID</label>
                <select class="form-select" id="token-client-id" required>
                  <option value="" selected disabled>Select a client</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <span class="spinner-border spinner-border-sm d-none" id="token-spinner"></span>
                <i class="bi bi-key-fill"></i> Generate Token
              </button>
            </form>
            <div id="token-result" class="mt-3" style="display: none;">
              <h5>Generated Token:</h5>
              <div class="token-display" id="token-display"></div>
              <div class="mt-2 action-buttons">
                <button class="btn btn-sm btn-outline-secondary" id="copy-token">
                  <i class="bi bi-clipboard"></i> Copy Token
                </button>
                <button class="btn btn-sm btn-outline-primary" id="copy-embed-code">
                  <i class="bi bi-code-slash"></i> Copy Embed Code
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lease Management Actions -->
    <div class="filter-section">
      <h5><i class="bi bi-tools"></i> Lease Management & Filters</h5>
      <div class="row">
        <div class="col-md-3 col-sm-6">
          <label class="form-label">Bulk Operations</label>
          <button class="btn btn-outline-warning btn-sm w-100" id="expire-clients-btn">
            <i class="bi bi-x-circle"></i> Expire Overdue
          </button>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="lease-status-filter" class="form-label">Lease Status</label>
          <select class="form-select form-select-sm" id="lease-status-filter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="expiring_soon">Expiring Soon</option>
            <option value="expired">Expired</option>
            <option value="grace_period">Grace Period</option>
          </select>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="duration-filter" class="form-label">Duration Filter</label>
          <select class="form-select form-select-sm" id="duration-filter">
            <option value="">All Durations</option>
            <option value="7">7 Days</option>
            <option value="14">14 Days</option>
            <option value="30">30 Days</option>
          </select>
        </div>
        <div class="col-md-3 col-sm-6">
          <label class="form-label">Actions</label>
          <button id="refresh-clients" class="btn btn-outline-primary btn-sm w-100">
            <span class="spinner-border spinner-border-sm d-none" id="refresh-spinner"></span>
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Client List -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> Client List with Lease Status</span>
        <span class="badge bg-light text-dark" id="client-count-badge">0 clients</span>
      </div>
      <div class="card-body">
        <div id="clients-loading" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span class="ms-2">Loading clients...</span>
        </div>
        
        <!-- Desktop Table View -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Client ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Lease Status</th>
                <th>Days Remaining</th>
                <th>Duration</th>
                <th>Renewals</th>
                <th>Requests</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="client-list">
              <!-- Client rows will be added here -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="page-info" id="page-info">
            Showing <span id="start-index">1</span>-<span id="end-index">10</span> of <span id="total-clients">0</span>
          </div>
          <nav aria-label="Client list pagination">
            <ul class="pagination pagination-sm mb-0" id="pagination-controls">
              <!-- Pagination controls will be added here -->
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Lease Management Modal -->
    <div class="modal fade" id="leaseManagementModal" tabindex="-1" aria-labelledby="leaseManagementModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="leaseManagementModalLabel">
              <i class="bi bi-calendar-check"></i> Lease Management
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Client Information</h6>
                <p><strong>Name:</strong> <span id="modal-client-name"></span></p>
                <p><strong>Email:</strong> <span id="modal-client-email"></span></p>
                <p><strong>Client ID:</strong> <span id="modal-client-id"></span></p>
              </div>
              <div class="col-md-6">
                <h6>Current Lease Status</h6>
                <p><strong>Status:</strong> <span id="modal-lease-status"></span></p>
                <p><strong>Days Remaining:</strong> <span id="modal-days-remaining"></span></p>
                <p><strong>Expiration Date:</strong> <span id="modal-expiration-date"></span></p>
                <p><strong>Renewals:</strong> <span id="modal-renewal-count"></span></p>
              </div>
            </div>
            
            <hr>
            
            <div class="row">
              <div class="col-md-6">
                <h6>Renew Lease</h6>
                <form id="renew-lease-form">
                  <input type="hidden" id="renew-client-id">
                  <div class="mb-3">
                    <label for="renew-duration" class="form-label">New Duration</label>
                    <select class="form-select" id="renew-duration" required>
                      <option value="7">7 Days</option>
                      <option value="14">14 Days</option>
                      <option value="30">30 Days</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-success w-100">
                    <span class="spinner-border spinner-border-sm d-none" id="renew-spinner"></span>
                    <i class="bi bi-arrow-clockwise"></i> Renew Lease
                  </button>
                </form>
              </div>
              <div class="col-md-6">
                <h6>Extend Current Lease</h6>
                <form id="extend-lease-form">
                  <input type="hidden" id="extend-client-id">
                  <div class="mb-3">
                    <label for="extend-days" class="form-label">Additional Days</label>
                    <input type="number" class="form-control" id="extend-days" min="1" max="90" required>
                  </div>
                  <button type="submit" class="btn btn-warning w-100">
                    <span class="spinner-border spinner-border-sm d-none" id="extend-spinner"></span>
                    <i class="bi bi-plus-circle"></i> Extend Lease
                  </button>
                </form>
              </div>
            </div>
            
            <hr>
            
            <div class="row">
              <div class="col-md-12">
                <h6>Lease History</h6>
                <div id="lease-history-container">
                  <div class="text-muted">Loading lease history...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editClientModalLabel">
              <i class="bi bi-pencil-square"></i> Edit Client
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="edit-client-form">
              <input type="hidden" id="edit-client-id">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit-client-name" class="form-label">Client Name</label>
                    <input type="text" class="form-control" id="edit-client-name" disabled>
                  </div>
                  <div class="mb-3">
                    <label for="edit-allowed-domains" class="form-label">Allowed Domains</label>
                    <input type="text" class="form-control" id="edit-allowed-domains">
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="edit-client-active">
                    <label class="form-check-label" for="edit-client-active">Active</label>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="edit-auto-renewal">
                    <label class="form-check-label" for="edit-auto-renewal">Auto Renewal</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit-primary-color" class="form-label">Primary Color</label>
                    <input type="color" class="form-control form-control-color" id="edit-primary-color" value="#0084ff">
                  </div>
                  <div class="mb-3">
                    <label for="edit-secondary-color" class="form-label">Secondary Color</label>
                    <input type="color" class="form-control form-control-color" id="edit-secondary-color" value="#ffffff">
                  </div>
                  <div class="mb-3">
                    <label for="edit-header-text" class="form-label">Header Text</label>
                    <input type="text" class="form-control" id="edit-header-text" value="Chat with us">
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-client-changes">
              <span class="spinner-border spinner-border-sm d-none" id="save-spinner"></span>
              <i class="bi bi-check-circle"></i> Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container">
    <div id="toast-notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-message">
        Action completed successfully.
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Configuration
    const API_BASE_URL = ''; // Your actual server URL
    const ADMIN_KEY = '12!Michael'; // The admin key from your .env file
    let clients = [];
    let currentClientId = '';
    let currentToken = '';
    let editClientModal;
    let leaseManagementModal;
    const toastEl = document.getElementById('toast-notification');
    let toast;

    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 10;
    let totalClients = 0;

    // Initialize components after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      toast = new bootstrap.Toast(toastEl);
      editClientModal = new bootstrap.Modal(document.getElementById('editClientModal'));
      leaseManagementModal = new bootstrap.Modal(document.getElementById('leaseManagementModal'));
      
      // Load lease dashboard stats
      loadLeaseStats();
      
      // Fetch clients on page load
      fetchClients(currentPage);
      
      // Set up filter event listeners
      setupFilterListeners();
    });

    // Setup filter event listeners
    function setupFilterListeners() {
      document.getElementById('lease-status-filter').addEventListener('change', function() {
        currentPage = 1;
        fetchClients(currentPage);
      });
      
      document.getElementById('duration-filter').addEventListener('change', function() {
        currentPage = 1;
        fetchClients(currentPage);
      });
    }

    // Load lease statistics
    async function loadLeaseStats() {
      try {
        console.log('=== LOADING LEASE STATS ===');
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        const response = await fetch(API_BASE_URL + '/api/clients/lease-dashboard', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'x-admin-key': ADMIN_KEY,
            'Cache-Control': 'no-cache'
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('Lease stats response status:', response.status);
        
        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (parseError) {
            const responseText = await response.text();
            console.error('Failed to parse lease stats error response:', parseError);
            console.error('Raw response:', responseText);
            throw new Error('HTTP ' + response.status + ': Failed to load dashboard');
          }
          
          console.error('Lease stats API error:', errorData);
          throw new Error(errorData.message || 'HTTP ' + response.status + ': ' + response.statusText);
        }
        
        const data = await response.json();
        console.log('Lease stats loaded:', data);
        
        // Validate response structure
        if (!data || !data.stats) {
          throw new Error('Invalid dashboard response: missing stats');
        }
        
        // Update statistics cards with error handling
        const updateStat = (elementId, value, fallback = 0) => {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = value !== undefined ? value : fallback;
          } else {
            console.warn('Element not found: ' + elementId);
          }
        };
        
        updateStat('active-leases-count', data.stats.leaseStatus && data.stats.leaseStatus.active);
        updateStat('expiring-soon-count', data.stats.leaseStatus && data.stats.leaseStatus.expiring3Days);
        updateStat('expired-count', data.stats.leaseStatus && data.stats.leaseStatus.expired);
        updateStat('total-clients-count', data.stats.totalClients);
        
        console.log('=== LEASE STATS SUCCESS ===');
        
      } catch (error) {
        console.error('=== LEASE STATS ERROR ===');
        console.error('Error details:', error);
        
        let errorMessage = 'Failed to load dashboard statistics';
        
        if (error.name === 'AbortError') {
          errorMessage = 'Dashboard request timed out';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Network error loading dashboard';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showNotification('Warning', errorMessage, 'warning');
        
        // Set default values on error
        const defaultStats = ['active-leases-count', 'expiring-soon-count', 'expired-count', 'total-clients-count'];
        defaultStats.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = '?';
            element.style.color = '#dc3545'; // Red color to indicate error
          }
        });
      }
    }

    // Show/hide loading spinners
    function toggleSpinner(elementId, show) {
      const spinner = document.getElementById(elementId);
      if (spinner) {
        if (show) {
          spinner.classList.remove('d-none');
        } else {
          spinner.classList.add('d-none');
        }
      }
    }

    // Show notification
    function showNotification(title, message, type = 'success') {
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-message').textContent = message;
      
      // Reset classes
      toastEl.className = 'toast';
      
      if (type === 'success') {
        toastEl.classList.add('bg-success', 'text-white');
      } else if (type === 'error') {
        toastEl.classList.add('bg-danger', 'text-white');
      } else if (type === 'warning') {
        toastEl.classList.add('bg-warning');
      }
      
      toast.show();
    }

    // Get lease status badge HTML
    function getLeaseStatusBadge(leaseStatus) {
      const statusMap = {
        'active': { class: 'lease-active', text: 'Active' },
        'expiring_soon': { class: 'lease-expiring', text: 'Expiring Soon' },
        'expired': { class: 'lease-expired', text: 'Expired' },
        'grace_period': { class: 'lease-grace', text: 'Grace Period' }
      };
      
      const status = statusMap[leaseStatus.status] || { class: 'bg-secondary', text: 'Unknown' };
      return '<span class="badge ' + status.class + ' lease-status-badge">' + status.text + '</span>';
    }

    // Get progress bar for days remaining
    function getDaysProgressBar(leaseStatus) {
      if (leaseStatus.status === 'expired') {
        return '<div class="progress-days"><div class="progress-fill expired" style="width: 100%"></div></div>';
      }
      
      const totalDays = 30; // Assuming max 30 days for progress calculation
      const remaining = Math.max(0, leaseStatus.daysRemaining);
      const percentage = Math.min(100, (remaining / totalDays) * 100);
      
      let progressClass = 'active';
      if (remaining <= 3) progressClass = 'expiring';
      if (remaining <= 0) progressClass = 'expired';
      
      return '<div class="progress-days"><div class="progress-fill ' + progressClass + '" style="width: ' + percentage + '%"></div></div>';
    }

    // Fetch clients with enhanced lease filtering
    async function fetchClients(page = 1, limit = pageSize) {
      try {
        console.log('=== FETCH CLIENTS START ===');
        console.log('Page:', page, 'Limit:', limit);
        
        document.getElementById('clients-loading').style.display = 'flex';
        toggleSpinner('refresh-spinner', true);
        
        // Build query parameters with validation
        const params = new URLSearchParams({
          page: Math.max(1, page),
          limit: Math.min(Math.max(1, limit), 100),
          sortBy: 'leaseConfig.expirationDate',
          sortOrder: 'asc'
        });
        
        // Add filters with validation
        const leaseStatusFilter = document.getElementById('lease-status-filter') && document.getElementById('lease-status-filter').value;
        const durationFilter = document.getElementById('duration-filter') && document.getElementById('duration-filter').value;
        
        if (leaseStatusFilter) params.append('leaseStatus', leaseStatusFilter);
        if (durationFilter) params.append('leaseDuration', durationFilter);
        
        console.log('Request URL:', API_BASE_URL + '/api/clients?' + params);
        console.log('Admin Key Set:', !!ADMIN_KEY);
        
        // Enhanced fetch with timeout and comprehensive error handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
        }, 30000); // 30 second timeout
        
        const response = await fetch(API_BASE_URL + '/api/clients?' + params, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'x-admin-key': ADMIN_KEY,
            'Cache-Control': 'no-cache'
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (parseError) {
            const responseText = await response.text();
            console.error('Failed to parse error response as JSON:', parseError);
            console.error('Raw response:', responseText);
            
            throw new Error('HTTP ' + response.status + ': ' + (response.statusText || 'Unknown error'));
          }
          
          console.error('API Error Response:', errorData);
          
          // Handle specific error cases
          if (response.status === 401) {
            throw new Error('Authentication failed. Please check your admin key.');
          } else if (response.status === 403) {
            throw new Error('Access denied. You do not have permission to view clients.');
          } else if (response.status === 500) {
            throw new Error(errorData.message || 'Server error occurred while fetching clients.');
          } else {
            throw new Error(errorData.message || 'HTTP ' + response.status + ': ' + response.statusText);
          }
        }
        
        const data = await response.json();
        console.log('Response data structure:', {
          hasClients: !!data.clients,
          clientsCount: data.clients && data.clients.length || 0,
          hasPagination: !!data.pagination,
          hasStats: !!data.stats
        });
        
        // Validate response structure
        if (!data || typeof data !== 'object') {
          throw new Error('Invalid response format: expected object');
        }
        
        if (!Array.isArray(data.clients)) {
          console.warn('Invalid clients data:', data.clients);
          throw new Error('Invalid response format: clients must be an array');
        }
        
        // Set global variables with fallbacks
        clients = data.clients || [];
        totalClients = data.pagination && data.pagination.total || 0;
        totalPages = data.pagination && data.pagination.pages || 1;
        currentPage = data.pagination && data.pagination.page || 1;
        
        console.log('Data processed successfully:', {
          clientsLoaded: clients.length,
          totalClients,
          currentPage,
          totalPages
        });
        
        // Update UI components
        updateClientsList();
        updateClientDropdown();
        updatePagination();
        
        // Update client count badge
        const countBadge = document.getElementById('client-count-badge');
        if (countBadge) {
          countBadge.textContent = totalClients + ' clients';
        }
        
        // Update stats if available
        if (data.stats) {
          const activeCountEl = document.getElementById('active-leases-count');
          const expiredCountEl = document.getElementById('expired-count');
          const totalCountEl = document.getElementById('total-clients-count');
          
          if (activeCountEl) activeCountEl.textContent = data.stats.totalActive || 0;
          if (expiredCountEl) expiredCountEl.textContent = data.stats.totalExpired || 0;
          if (totalCountEl) totalCountEl.textContent = data.stats.totalClients || 0;
        }
        
        console.log('=== FETCH CLIENTS SUCCESS ===');
        showNotification('Success', 'Clients loaded successfully');
        
      } catch (error) {
        console.error('=== FETCH CLIENTS ERROR ===');
        console.error('Error details:', error);
        console.error('Error stack:', error.stack);
        
        // Handle specific error types
        let errorMessage = 'Failed to load clients';
        
        if (error.name === 'AbortError') {
          errorMessage = 'Request timed out. Please check your connection and try again.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Network error. Please check your internet connection.';
        } else if (error.message.includes('Authentication failed')) {
          errorMessage = 'Authentication failed. Please refresh the page and try again.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showNotification('Error', errorMessage, 'error');
        
        // Set empty state with error information
        clients = [];
        totalClients = 0;
        totalPages = 1;
        currentPage = 1;
        
        // Update UI to show error state
        updateClientsList();
        updateClientDropdown();
        updatePagination();
        
        // Show error details in client list
        const clientList = document.getElementById('client-list');
        
        if (clientList) {
          clientList.innerHTML = '<tr><td colspan="9" class="text-center py-4"><div class="alert alert-danger"><h5>Failed to Load Clients</h5><p>' + errorMessage + '</p><button class="btn btn-outline-danger btn-sm" onclick="fetchClients(1)"><i class="bi bi-arrow-clockwise"></i> Retry</button></div></td></tr>';
        }
        
        // Update badges to show error state
        const badges = ['active-leases-count', 'expired-count', 'total-clients-count', 'client-count-badge'];
        badges.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = id === 'client-count-badge' ? 'Error' : '?';
          }
        });
        
      } finally {
        // Always hide loading indicators
        const loadingEl = document.getElementById('clients-loading');
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
        toggleSpinner('refresh-spinner', false);
        
        console.log('=== FETCH CLIENTS COMPLETE ===');
      }
    }

    // Update clients list with lease information
    function updateClientsList() {
      const clientList = document.getElementById('client-list');
      
      // Clear desktop view
      clientList.innerHTML = '';
      
      if (clients.length === 0) {
        // Desktop empty state
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="9" class="text-center py-4">No clients found. Create your first client to get started.</td>';
        clientList.appendChild(row);
        return;
      }
      
      clients.forEach(client => {
        const leaseStatus = client.leaseStatus || { status: 'unknown', daysRemaining: 0 };
        const leaseInfo = client.leaseInfo || {};
        
        // Desktop table row
        const row = document.createElement('tr');
        row.className = 'client-row';
        
        row.innerHTML = '<td class="copyable" onclick="copyToClipboard(\'' + client.clientId + '\')" title="Click to copy">' + client.clientId + '</td>' +
          '<td>' + client.name + '</td>' +
          '<td>' + client.email + '</td>' +
          '<td>' + getLeaseStatusBadge(leaseStatus) + '</td>' +
          '<td><div>' + (leaseStatus.daysRemaining >= 0 ? leaseStatus.daysRemaining : 'Expired') + '</div>' + getDaysProgressBar(leaseStatus) + '</td>' +
          '<td>' + (leaseInfo.duration || 'N/A') + ' days</td>' +
          '<td>' + (leaseInfo.renewalCount || 0) + '</td>' +
          '<td>' + (client.requestCount || 0) + '</td>' +
          '<td><div class="lease-actions">' +
          '<button class="btn btn-sm btn-outline-primary edit-client" data-client-id="' + client.clientId + '" title="Edit Client"><i class="bi bi-pencil"></i></button>' +
          '<button class="btn btn-sm btn-outline-success manage-lease" data-client-id="' + client.clientId + '" title="Manage Lease"><i class="bi bi-calendar-check"></i></button>' +
          '<button class="btn btn-sm btn-outline-warning ' + (client.active ? 'deactivate-client' : 'activate-client') + '" data-client-id="' + client.clientId + '" title="' + (client.active ? 'Deactivate' : 'Activate') + '"><i class="bi bi-' + (client.active ? 'pause' : 'play') + '-circle"></i></button>' +
          '<button class="btn btn-sm btn-outline-danger delete-client" data-client-id="' + client.clientId + '" title="Delete Client"><i class="bi bi-trash"></i></button>' +
          '</div></td>';
        
        clientList.appendChild(row);
      });
      
      // Add event listeners to elements
      document.querySelectorAll('.edit-client').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          openEditClientModal(clientId);
        });
      });
      
      document.querySelectorAll('.manage-lease').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          openLeaseManagementModal(clientId);
        });
      });
      
      document.querySelectorAll('.activate-client, .deactivate-client').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          const activate = this.classList.contains('activate-client');
          toggleClientStatus(clientId, activate, this);
        });
      });
      
      document.querySelectorAll('.delete-client').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          deleteClient(clientId, this);
        });
      });
    }

    // Update client dropdown in the token generation form
    function updateClientDropdown() {
      const dropdown = document.getElementById('token-client-id');
      dropdown.innerHTML = '<option value="" selected disabled>Select a client</option>';
      
      const activeClients = clients.filter(client => client.active && client.leaseStatus && client.leaseStatus.status !== 'expired');
      
      if (activeClients.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "No active clients with valid leases";
        option.disabled = true;
        dropdown.appendChild(option);
        return;
      }
      
      activeClients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.clientId;
        const leaseInfo = client.leaseStatus ? ' (' + client.leaseStatus.daysRemaining + ' days left)' : '';
        option.textContent = client.name + ' (' + client.clientId + ')' + leaseInfo;
        dropdown.appendChild(option);
      });
    }

    // Update pagination display and controls
    function updatePagination() {
      const startIndex = (currentPage - 1) * pageSize + 1;
      const endIndex = Math.min(currentPage * pageSize, totalClients);
      
      document.getElementById('start-index').textContent = totalClients > 0 ? startIndex : 0;
      document.getElementById('end-index').textContent = endIndex;
      document.getElementById('total-clients').textContent = totalClients;
      
      const paginationControls = document.getElementById('pagination-controls');
      paginationControls.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-link';
      prevBtn.innerHTML = '&laquo;';
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          fetchClients(currentPage - 1);
        }
      });
      prevLi.appendChild(prevBtn);
      paginationControls.appendChild(prevLi);
      
      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = 'page-item' + (i === currentPage ? ' active' : '');
        const pageBtn = document.createElement('button');
        pageBtn.className = 'page-link';
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
          if (i !== currentPage) {
            fetchClients(i);
          }
        });
        pageLi.appendChild(pageBtn);
        paginationControls.appendChild(pageLi);
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-link';
      nextBtn.innerHTML = '&raquo;';
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          fetchClients(currentPage + 1);
        }
      });
      nextLi.appendChild(nextBtn);
      paginationControls.appendChild(nextLi);
    }

    // Helper function to copy text to clipboard
    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          showNotification('Copied', 'Copied to clipboard');
        })
        .catch(err => {
          console.error('Failed to copy:', err);
          showNotification('Error', 'Failed to copy to clipboard', 'error');
        });
    };

    // Generate token for client - FIXED VERSION
    document.getElementById('generate-token-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientId = document.getElementById('token-client-id').value;
      if (!clientId) {
        showNotification('Error', 'Please select a client', 'error');
        return;
      }
      
      console.log('=== TOKEN GENERATION START ===');
      console.log('Selected client ID:', clientId);
      
      toggleSpinner('token-spinner', true);
      
      try {
        console.log('Sending token generation request...');
        
        const requestBody = {
          clientId: clientId,
          adminKey: ADMIN_KEY
        };
        
        console.log('Request body:', requestBody);
        
        const response = await fetch(API_BASE_URL + '/api/auth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (parseError) {
            const responseText = await response.text();
            console.error('Failed to parse error response:', parseError);
            console.error('Raw response:', responseText);
            throw new Error('HTTP ' + response.status + ': ' + (response.statusText || 'Unknown error'));
          }
          
          console.error('Token generation API error:', errorData);
          throw new Error(errorData.message || errorData.error || 'HTTP ' + response.status + ': ' + response.statusText);
        }
        
        // Parse response data properly
        const data = await response.json();
        console.log('Token generation response:', data);
        
        // Validate response structure
        if (!data || !data.token) {
          console.error('Invalid response structure:', data);
          throw new Error('Invalid response: missing token');
        }
        
        // Set global variables properly
        currentClientId = clientId;
        currentToken = data.token;
        
        // Display token
        document.getElementById('token-display').textContent = data.token;
        document.getElementById('token-result').style.display = 'block';
        
        console.log('=== TOKEN GENERATION SUCCESS ===');
        showNotification('Success', 'Token generated successfully');
        
        // Show warning notifications if present
        if (data.warning) {
          setTimeout(() => {
            showNotification('Warning', data.warning.message, 'warning');
          }, 1000);
        }
        
      } catch (error) {
        console.error('=== TOKEN GENERATION ERROR ===');
        console.error('Error details:', error);
        
        let errorMessage = 'Failed to generate token';
        
        if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Network error. Please check your connection.';
        } else if (error.message.includes('Invalid admin key')) {
          errorMessage = 'Authentication failed. Please refresh the page.';
        } else if (error.message.includes('Client not found')) {
          errorMessage = 'Selected client not found. Please refresh and try again.';
        } else if (error.message.includes('Lease expired')) {
          errorMessage = 'Cannot generate token: Client lease has expired.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showNotification('Error', errorMessage, 'error');
        
        // Hide token result section on error
        document.getElementById('token-result').style.display = 'none';
        
      } finally {
        toggleSpinner('token-spinner', false);
        console.log('=== TOKEN GENERATION COMPLETE ===');
      }
    });

    // Copy token to clipboard
    document.getElementById('copy-token').addEventListener('click', function() {
      navigator.clipboard.writeText(currentToken)
        .then(() => {
          showNotification('Copied', 'Token copied to clipboard');
        })
        .catch(err => {
          console.error('Failed to copy token:', err);
          showNotification('Error', 'Failed to copy to clipboard', 'error');
        });
    });

    // Copy embed code to clipboard - FIXED VERSION
    document.getElementById('copy-embed-code').addEventListener('click', function() {
      if (!currentToken || !currentClientId) {
        showNotification('Error', 'No token or client ID available', 'error');
        return;
      }
      
      const serverUrl = API_BASE_URL || window.location.origin;
      const embedCode = '<script src="' + serverUrl + '/widget.js"><\/script>\n<script>\n  window.MyChatWidget.init({\n    token: "' + currentToken + '",\n    clientId: "' + currentClientId + '"\n  });\n<\/script>';
      
      navigator.clipboard.writeText(embedCode)
        .then(() => {
          showNotification('Copied', 'Embed code copied to clipboard');
          
          // Visual feedback
          const button = this;
          const originalText = button.innerHTML;
          button.innerHTML = '<i class="bi bi-check"></i> Copied!';
          button.classList.add('btn-success');
          button.classList.remove('btn-outline-primary');
          
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-primary');
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy embed code:', err);
          showNotification('Error', 'Failed to copy to clipboard', 'error');
        });
    });

    // Create client form with lease duration
    document.getElementById('create-client-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('client-name').value.trim();
      const email = document.getElementById('client-email').value.trim();
      const leaseDuration = parseInt(document.getElementById('lease-duration').value);
      const allowedDomainsStr = document.getElementById('allowed-domains').value.trim();
      const widgetId = "6809b3a1523186af0b2c9933";
      
      let allowedDomains = [];
      if (allowedDomainsStr) {
        allowedDomains = allowedDomainsStr.split(',').map(domain => domain.trim());
      }
      
      toggleSpinner('create-spinner', true);
      
      try {
        const response = await fetch(API_BASE_URL + '/api/clients', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            name,
            email,
            allowedDomains,
            widgetId,
            leaseDuration,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        const data = await response.json();
        
        // Reset form
        document.getElementById('create-client-form').reset();
        document.getElementById('lease-duration').value = '30'; // Reset to default
        
        // Refresh client list and stats
        await fetchClients(1);
        await loadLeaseStats();
        
        showNotification('Success', 'Client created successfully with ' + leaseDuration + '-day lease');
        
      } catch (error) {
        console.error('Error creating client:', error);
        showNotification('Error', 'Failed to create client: ' + error.message, 'error');
      } finally {
        toggleSpinner('create-spinner', false);
      }
    });

    // Refresh clients button
    document.getElementById('refresh-clients').addEventListener('click', function() {
      fetchClients(currentPage);
    });

    // Complete Action Button Functions Implementation

    // Open edit client modal with full implementation
    async function openEditClientModal(clientId) {
      try {
        const client = clients.find(c => c.clientId === clientId);
        if (!client) {
          showNotification('Error', 'Client not found', 'error');
          return;
        }
        
        // Populate edit form with client data
        document.getElementById('edit-client-id').value = client.clientId;
        document.getElementById('edit-client-name').value = client.name;
        document.getElementById('edit-allowed-domains').value = client.allowedDomains ? client.allowedDomains.join(', ') : '';
        document.getElementById('edit-client-active').checked = client.active;
        document.getElementById('edit-auto-renewal').checked = client.leaseInfo && client.leaseInfo.autoRenewal || false;
        
        // Set customization values
        const customization = client.chatbotConfig && client.chatbotConfig.customization || {};
        document.getElementById('edit-primary-color').value = customization.primaryColor || '#0084ff';
        document.getElementById('edit-secondary-color').value = customization.secondaryColor || '#ffffff';
        document.getElementById('edit-header-text').value = customization.headerText || 'Chat with us';
        
        // Show the modal
        editClientModal.show();
        
      } catch (error) {
        console.error('Error opening edit modal:', error);
        showNotification('Error', 'Failed to open edit dialog', 'error');
      }
    }

    // Save client changes implementation
    document.getElementById('save-client-changes').addEventListener('click', async function() {
      const clientId = document.getElementById('edit-client-id').value;
      const allowedDomainsStr = document.getElementById('edit-allowed-domains').value.trim();
      const active = document.getElementById('edit-client-active').checked;
      const autoRenewal = document.getElementById('edit-auto-renewal').checked;
      
      let allowedDomains = [];
      if (allowedDomainsStr) {
        allowedDomains = allowedDomainsStr.split(',').map(domain => domain.trim());
      }
      
      const customization = {
        primaryColor: document.getElementById('edit-primary-color').value,
        secondaryColor: document.getElementById('edit-secondary-color').value,
        headerText: document.getElementById('edit-header-text').value.trim()
      };
      
      toggleSpinner('save-spinner', true);
      
      try {
        const response = await fetch(API_BASE_URL + '/api/clients/' + clientId, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            active,
            allowedDomains,
            customization,
            autoRenewal,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        await fetchClients(currentPage);
        editClientModal.hide();
        showNotification('Success', 'Client updated successfully');
      } catch (error) {
        console.error('Error updating client:', error);
        showNotification('Error', 'Failed to update client: ' + error.message, 'error');
      } finally {
        toggleSpinner('save-spinner', false);
      }
    });

    // Open lease management modal with full implementation
    async function openLeaseManagementModal(clientId) {
      try {
        const client = clients.find(c => c.clientId === clientId);
        if (!client) {
          showNotification('Error', 'Client not found', 'error');
          return;
        }
        
        const leaseStatus = client.leaseStatus || {};
        const leaseInfo = client.leaseInfo || {};
        
        // Populate modal with client and lease information
        document.getElementById('modal-client-name').textContent = client.name;
        document.getElementById('modal-client-email').textContent = client.email;
        document.getElementById('modal-client-id').textContent = client.clientId;
        document.getElementById('modal-lease-status').innerHTML = getLeaseStatusBadge(leaseStatus);
        document.getElementById('modal-days-remaining').textContent = leaseStatus.daysRemaining >= 0 ? leaseStatus.daysRemaining : 'Expired';
        document.getElementById('modal-expiration-date').textContent = leaseInfo.expirationDate ? new Date(leaseInfo.expirationDate).toLocaleDateString() : 'N/A';
        document.getElementById('modal-renewal-count').textContent = leaseInfo.renewalCount || 0;
        
        // Set form values
        document.getElementById('renew-client-id').value = clientId;
        document.getElementById('extend-client-id').value = clientId;
        
        // Load lease history
        await loadLeaseHistory(clientId);
        
        leaseManagementModal.show();
        
      } catch (error) {
        console.error('Error opening lease management modal:', error);
        showNotification('Error', 'Failed to open lease management', 'error');
      }
    }

    // Load lease history for a client
    async function loadLeaseHistory(clientId) {
      try {
        const response = await fetch(API_BASE_URL + '/api/clients/' + clientId + '/lease-history', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          }
        });
        
        if (!response.ok) {
          throw new Error('Server responded with status: ' + response.status);
        }
        
        const data = await response.json();
        const historyContainer = document.getElementById('lease-history-container');
        
        if (data.leaseHistory && data.leaseHistory.length > 0) {
          let historyHtml = '<div class="table-responsive"><table class="table table-sm">';
          historyHtml += '<thead><tr><th>Start Date</th><th>End Date</th><th>Duration</th><th>Type</th><th>Renewed By</th></tr></thead><tbody>';
          
          data.leaseHistory.forEach(lease => {
            historyHtml += '<tr>' +
              '<td>' + new Date(lease.startDate).toLocaleDateString() + '</td>' +
              '<td>' + new Date(lease.endDate).toLocaleDateString() + '</td>' +
              '<td>' + lease.duration + ' days</td>' +
              '<td><span class="badge bg-secondary">' + lease.renewalType + '</span></td>' +
              '<td>' + (lease.renewedBy || 'N/A') + '</td>' +
              '</tr>';
          });
          
          historyHtml += '</tbody></table></div>';
          historyContainer.innerHTML = historyHtml;
        } else {
          historyContainer.innerHTML = '<div class="text-muted">No lease history available.</div>';
        }
      } catch (error) {
        console.error('Error loading lease history:', error);
        document.getElementById('lease-history-container').innerHTML = '<div class="text-danger">Failed to load lease history.</div>';
      }
    }

    // Renew lease form handler
    document.getElementById('renew-lease-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientId = document.getElementById('renew-client-id').value;
      const duration = parseInt(document.getElementById('renew-duration').value);
      
      toggleSpinner('renew-spinner', true);
      
      try {
        const response = await fetch(API_BASE_URL + '/api/clients/' + clientId + '/renew-lease', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            duration: duration,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        const data = await response.json();
        
        // Refresh clients and close modal
        await fetchClients(currentPage);
        await loadLeaseStats();
        leaseManagementModal.hide();
        
        showNotification('Success', 'Lease renewed successfully for ' + duration + ' days');
        
      } catch (error) {
        console.error('Error renewing lease:', error);
        showNotification('Error', 'Failed to renew lease: ' + error.message, 'error');
      } finally {
        toggleSpinner('renew-spinner', false);
      }
    });

    // Extend lease form handler
    document.getElementById('extend-lease-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientId = document.getElementById('extend-client-id').value;
      const additionalDays = parseInt(document.getElementById('extend-days').value);
      
      toggleSpinner('extend-spinner', true);
      
      try {
        const response = await fetch(API_BASE_URL + '/api/clients/' + clientId + '/extend-lease', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            additionalDays: additionalDays,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        const data = await response.json();
        
        // Refresh clients and close modal
        await fetchClients(currentPage);
        await loadLeaseStats();
        leaseManagementModal.hide();
        
        showNotification('Success', 'Lease extended by ' + additionalDays + ' days');
        
      } catch (error) {
        console.error('Error extending lease:', error);
        showNotification('Error', 'Failed to extend lease: ' + error.message, 'error');
      } finally {
        toggleSpinner('extend-spinner', false);
      }
    });

    // Toggle client status implementation
    async function toggleClientStatus(clientId, activate, buttonElement) {
      if (buttonElement) {
        buttonElement.disabled = true;
      }
      
      try {
        const response = await fetch(API_BASE_URL + '/api/clients/' + clientId, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            active: activate,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        await fetchClients(currentPage);
        await loadLeaseStats();
        
        showNotification('Success', 'Client ' + (activate ? 'activated' : 'deactivated') + ' successfully');
      } catch (error) {
        console.error('Error toggling client status:', error);
        showNotification('Error', 'Failed to update client status: ' + error.message, 'error');
      } finally {
        if (buttonElement) {
          buttonElement.disabled = false;
        }
      }
    }

    // Delete client implementation
    async function deleteClient(clientId, buttonElement) {
      // Get client name for confirmation
      const client = clients.find(c => c.clientId === clientId);
      const clientName = client ? client.name : clientId;
      
      if (!confirm('Are you sure you want to permanently delete client "' + clientName + '" (' + clientId + ')?\n\nThis action cannot be undone and will remove all lease history.')) {
        return;
      }
      
      if (buttonElement) {
        buttonElement.disabled = true;
      }
      
      try {
        const response = await fetch(API_BASE_URL + '/api/clients/' + clientId + '?confirm=true', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        const data = await response.json();
        
        // If we're on the last page and this was the only client, go back a page
        const shouldGoBack = clients.length === 1 && currentPage > 1;
        
        await fetchClients(shouldGoBack ? currentPage - 1 : currentPage);
        await loadLeaseStats();
        
        showNotification('Success', 'Client "' + clientName + '" deleted successfully');
      } catch (error) {
        console.error('Error deleting client:', error);
        showNotification('Error', 'Failed to delete client: ' + error.message, 'error');
      } finally {
        if (buttonElement) {
          buttonElement.disabled = false;
        }
      }
    }

    // Bulk expire clients implementation
    document.getElementById('expire-clients-btn').addEventListener('click', async function() {
      if (!confirm('Are you sure you want to expire all overdue client leases?\n\nThis will deactivate clients whose lease grace period has ended.')) {
        return;
      }
      
      try {
        const response = await fetch(API_BASE_URL + '/api/lease/expire-clients', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Server responded with status: ' + response.status);
        }
        
        const data = await response.json();
        
        await fetchClients(currentPage);
        await loadLeaseStats();
        
        showNotification('Success', 'Bulk expiration completed: ' + data.results.summary);
        
      } catch (error) {
        console.error('Error expiring clients:', error);
        showNotification('Error', 'Failed to expire clients: ' + error.message, 'error');
      }
    });

    // Add keyboard shortcuts for power users
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + R for refresh
      if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        fetchClients(currentPage);
        loadLeaseStats();
        showNotification('Refreshed', 'Data refreshed manually');
      }
      
      // Escape to close modals
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
          const modalInstance = bootstrap.Modal.getInstance(modal);
          if (modalInstance) {
            modalInstance.hide();
          }
        });
      }
    });

    // Auto-refresh lease stats every 5 minutes
    setInterval(loadLeaseStats, 5 * 60 * 1000);

    // Auto-refresh client list every 2 minutes to catch lease status changes
    setInterval(() => {
      fetchClients(currentPage);
    }, 2 * 60 * 1000);

    // Enhanced error handling for network issues
    window.addEventListener('online', function() {
      showNotification('Connected', 'Internet connection restored', 'success');
      // Refresh data when connection is restored
      setTimeout(() => {
        fetchClients(currentPage);
        loadLeaseStats();
      }, 1000);
    });

    window.addEventListener('offline', function() {
      showNotification('Offline', 'No internet connection', 'warning');
    });

    console.log('✅ All action button functions loaded successfully');
  </script>
</body>
</html>
  </script>
</body>
</html>