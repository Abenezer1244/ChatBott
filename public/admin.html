<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Lease Management Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding-top: 20px;
      font-size: 14px;
    }
    
    /* Mobile-first responsive design */
    @media (max-width: 768px) {
      body {
        padding-top: 10px;
        font-size: 13px;
      }
      
      .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
      }
      
      .card {
        margin-bottom: 15px;
      }
      
      .card-body {
        padding: 15px;
      }
      
      .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
      }
      
      .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      
      .table-responsive {
        font-size: 0.8rem;
      }
      
      .stats-card h3 {
        font-size: 1.5rem;
      }
      
      .stats-card h6 {
        font-size: 0.8rem;
      }
      
      .lease-actions {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .lease-actions .btn {
        width: 100%;
        justify-content: center;
      }
      
      .modal-dialog {
        margin: 0.5rem;
      }
      
      .form-control, .form-select {
        font-size: 0.875rem;
      }
      
      .pagination {
        font-size: 0.8rem;
      }
      
      .toast {
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 576px) {
      .col-md-3, .col-md-4, .col-md-6 {
        margin-bottom: 1rem;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .stats-grid .col-md-3 {
        margin-bottom: 0;
      }
      
      .table th, .table td {
        padding: 0.4rem;
        font-size: 0.75rem;
        white-space: nowrap;
      }
      
      .client-actions-mobile {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .client-actions-mobile .btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
    }
    
    /* Card styles */
    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
      border-radius: 10px;
    }
    
    .card-header {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      color: white;
      font-weight: 600;
      border-radius: 10px 10px 0 0;
      padding: 15px 20px;
    }
    
    /* Lease status badges */
    .lease-status-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 15px;
      font-weight: 500;
    }
    
    .lease-expired { 
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }
    
    .lease-expiring { 
      background: linear-gradient(135deg, #fd7e14, #e55100);
      color: white;
    }
    
    .lease-active { 
      background: linear-gradient(135deg, #198754, #157347);
      color: white;
    }
    
    .lease-grace { 
      background: linear-gradient(135deg, #ffc107, #ffb302);
      color: #000;
    }
    
    /* Stats cards */
    .stats-card {
      border-left: 4px solid #0d6efd;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stats-card.danger {
      border-left-color: #dc3545;
    }
    
    .stats-card.warning {
      border-left-color: #ffc107;
    }
    
    .stats-card.success {
      border-left-color: #198754;
    }
    
    .stats-card .card-body {
      padding: 1.5rem;
    }
    
    .stats-card h3 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }
    
    /* Client row styles */
    .client-row {
      transition: background-color 0.2s;
    }
    
    .client-row:hover {
      background-color: #f1f5f9;
    }
    
    /* Copyable elements */
    .copyable {
      cursor: pointer;
      transition: all 0.2s;
      padding: 0.25rem;
      border-radius: 4px;
    }
    
    .copyable:hover {
      background-color: #e9ecef;
      color: #0d6efd;
    }
    
    /* Token display */
    .token-display {
      word-break: break-all;
      font-family: 'Courier New', monospace;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ced4da;
      margin-top: 10px;
      font-size: 0.85rem;
      max-height: 150px;
      overflow-y: auto;
    }
    
    /* Loading states */
    .loading {
      display: none;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    
    /* Lease actions */
    .lease-actions {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    
    .lease-actions .btn {
      flex: 0 0 auto;
    }
    
    /* Progress bars */
    .progress-days {
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }
    
    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .progress-fill.active { 
      background: linear-gradient(90deg, #198754, #20c997);
    }
    
    .progress-fill.expiring { 
      background: linear-gradient(90deg, #fd7e14, #ff8f00);
    }
    
    .progress-fill.expired { 
      background: linear-gradient(90deg, #dc3545, #c82333);
    }
    
    /* Enhanced form styles */
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* Responsive table improvements */
    @media (max-width: 992px) {
      .table-responsive {
        border: none;
      }
      
      .table-responsive table {
        min-width: 800px;
      }
    }
    
    /* Custom scrollbar for mobile */
    .table-responsive::-webkit-scrollbar {
      height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Toast notifications positioning */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    
    @media (max-width: 768px) {
      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
      }
      
      .toast {
        width: 100%;
      }
    }
    
    /* Modal improvements for mobile */
    @media (max-width: 576px) {
      .modal-dialog {
        max-width: 95%;
        margin: 10px auto;
      }
      
      .modal-content {
        border-radius: 10px;
      }
      
      .modal-header {
        padding: 15px;
      }
      
      .modal-body {
        padding: 15px;
      }
      
      .modal-footer {
        padding: 15px;
        flex-direction: column;
      }
      
      .modal-footer .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      .modal-footer .btn:last-child {
        margin-bottom: 0;
      }
    }
    
    /* Pagination responsive */
    @media (max-width: 576px) {
      .pagination {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .page-item {
        margin: 1px;
      }
      
      .page-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
      }
    }
    
    /* Utility classes for mobile */
    .mobile-hide {
      display: block;
    }
    
    .mobile-show {
      display: none;
    }
    
    @media (max-width: 768px) {
      .mobile-hide {
        display: none;
      }
      
      .mobile-show {
        display: block;
      }
    }
    
    /* Enhanced button styles */
    .btn {
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      border: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #198754, #157347);
      border: none;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #ffb302);
      border: none;
      color: #000;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      border: none;
    }
    
    /* Spinner improvements */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Alert styles */
    .alert {
      border: none;
      border-radius: 8px;
      font-weight: 500;
    }
    
    /* Page header responsive */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .page-header h1 {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    @media (max-width: 768px) {
      .page-header {
        margin-bottom: 1rem;
      }
      
      .page-header h1 {
        font-size: 1.75rem;
      }
    }
    
    /* Search and filter improvements */
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 768px) {
      .filter-section {
        padding: 15px;
      }
      
      .filter-section .row > div {
        margin-bottom: 15px;
      }
    }
    
    /* Action button improvements */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    
    @media (max-width: 576px) {
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons .btn {
        width: 100%;
      }
    }
    
    /* Client card for mobile view */
    .client-card-mobile {
      display: none;
    }
    
    @media (max-width: 992px) {
      .table-responsive {
        display: none;
      }
      
      .client-card-mobile {
        display: block;
      }
      
      .client-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #0d6efd;
      }
      
      .client-card.lease-expired {
        border-left-color: #dc3545;
      }
      
      .client-card.lease-expiring {
        border-left-color: #fd7e14;
      }
      
      .client-card.lease-active {
        border-left-color: #198754;
      }
      
      .client-card.lease-grace {
        border-left-color: #ffc107;
      }
      
      .client-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }
      
      .client-card-title {
        font-weight: 600;
        color: #212529;
        margin: 0;
      }
      
      .client-card-id {
        font-size: 0.8rem;
        color: #6c757d;
        font-family: 'Courier New', monospace;
      }
      
      .client-card-body {
        margin-bottom: 15px;
      }
      
      .client-card-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .client-card-info-item {
        font-size: 0.85rem;
      }
      
      .client-card-info-label {
        font-weight: 500;
        color: #495057;
      }
      
      .client-card-info-value {
        color: #212529;
      }
      
      .client-card-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      
      .client-card-actions .btn {
        flex: 1;
        min-width: calc(50% - 0.25rem);
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
      <h1><i class="bi bi-calendar-check"></i> Chatbot Lease Management Dashboard</h1>
    </div>

    <!-- Lease Statistics Cards -->
    <div class="row stats-grid mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card success">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Active Leases</h6>
                <h3 class="mb-0" id="active-leases-count">-</h3>
              </div>
              <div class="text-success">
                <i class="bi bi-check-circle-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card warning">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Expiring Soon</h6>
                <h3 class="mb-0" id="expiring-soon-count">-</h3>
              </div>
              <div class="text-warning">
                <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card danger">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Expired</h6>
                <h3 class="mb-0" id="expired-count">-</h3>
              </div>
              <div class="text-danger">
                <i class="bi bi-x-circle-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="card-title text-muted mb-1">Total Clients</h6>
                <h3 class="mb-0" id="total-clients-count">-</h3>
              </div>
              <div class="text-primary">
                <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Create New Client -->
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-person-plus"></i> Create New Client
          </div>
          <div class="card-body">
            <form id="create-client-form">
              <div class="mb-3">
                <label for="client-name" class="form-label">Client Name</label>
                <input type="text" class="form-control" id="client-name" required>
              </div>
              <div class="mb-3">
                <label for="client-email" class="form-label">Client Email</label>
                <input type="email" class="form-control" id="client-email" required>
              </div>
              <div class="mb-3">
                <label for="lease-duration" class="form-label">Lease Duration</label>
                <select class="form-select" id="lease-duration" required>
                  <option value="7">7 Days</option>
                  <option value="14">14 Days</option>
                  <option value="30" selected>30 Days</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="allowed-domains" class="form-label">Allowed Domains</label>
                <input type="text" class="form-control" id="allowed-domains" 
                       placeholder="example.com, client-site.org">
                <div class="form-text">Leave empty to allow all domains</div>
              </div>
              <button type="submit" class="btn btn-success w-100">
                <span class="spinner-border spinner-border-sm d-none" id="create-spinner"></span>
                <i class="bi bi-plus-circle"></i> Create Client
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Generate Token -->
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-key"></i> Generate Token
          </div>
          <div class="card-body">
            <form id="generate-token-form">
              <div class="mb-3">
                <label for="token-client-id" class="form-label">Client ID</label>
                <select class="form-select" id="token-client-id" required>
                  <option value="" selected disabled>Select a client</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <span class="spinner-border spinner-border-sm d-none" id="token-spinner"></span>
                <i class="bi bi-key-fill"></i> Generate Token
              </button>
            </form>
            <div id="token-result" class="mt-3" style="display: none;">
              <h5>Generated Token:</h5>
              <div class="token-display" id="token-display"></div>
              <div class="mt-2 action-buttons">
                <button class="btn btn-sm btn-outline-secondary" id="copy-token">
                  <i class="bi bi-clipboard"></i> Copy Token
                </button>
                <button class="btn btn-sm btn-outline-primary" id="copy-embed-code">
                  <i class="bi bi-code-slash"></i> Copy Embed Code
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lease Management Actions -->
    <div class="filter-section">
      <h5><i class="bi bi-tools"></i> Lease Management & Filters</h5>
      <div class="row">
        <div class="col-md-3 col-sm-6">
          <label class="form-label">Bulk Operations</label>
          <button class="btn btn-outline-warning btn-sm w-100" id="expire-clients-btn">
            <i class="bi bi-x-circle"></i> Expire Overdue
          </button>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="lease-status-filter" class="form-label">Lease Status</label>
          <select class="form-select form-select-sm" id="lease-status-filter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="expiring_soon">Expiring Soon</option>
            <option value="expired">Expired</option>
            <option value="grace_period">Grace Period</option>
          </select>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="duration-filter" class="form-label">Duration Filter</label>
          <select class="form-select form-select-sm" id="duration-filter">
            <option value="">All Durations</option>
            <option value="7">7 Days</option>
            <option value="14">14 Days</option>
            <option value="30">30 Days</option>
          </select>
        </div>
        <div class="col-md-3 col-sm-6">
          <label class="form-label">Actions</label>
          <button id="refresh-clients" class="btn btn-outline-primary btn-sm w-100">
            <span class="spinner-border spinner-border-sm d-none" id="refresh-spinner"></span>
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Client List -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> Client List with Lease Status</span>
        <span class="badge bg-light text-dark" id="client-count-badge">0 clients</span>
      </div>
      <div class="card-body">
        <div id="clients-loading" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span class="ms-2">Loading clients...</span>
        </div>
        
        <!-- Desktop Table View -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Client ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Lease Status</th>
                <th>Days Remaining</th>
                <th>Duration</th>
                <th>Renewals</th>
                <th>Requests</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="client-list">
              <!-- Client rows will be added here -->
            </tbody>
          </table>
        </div>
        
        <!-- Mobile Card View -->
        <div class="client-card-mobile" id="client-cards">
          <!-- Client cards will be added here -->
        </div>
        
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="page-info" id="page-info">
            Showing <span id="start-index">1</span>-<span id="end-index">10</span> of <span id="total-clients">0</span>
          </div>
          <nav aria-label="Client list pagination">
            <ul class="pagination pagination-sm mb-0" id="pagination-controls">
              <!-- Pagination controls will be added here -->
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Lease Management Modal -->
    <div class="modal fade" id="leaseManagementModal" tabindex="-1" aria-labelledby="leaseManagementModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="leaseManagementModalLabel">
              <i class="bi bi-calendar-check"></i> Lease Management
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Client Information</h6>
                <p><strong>Name:</strong> <span id="modal-client-name"></span></p>
                <p><strong>Email:</strong> <span id="modal-client-email"></span></p>
                <p><strong>Client ID:</strong> <span id="modal-client-id"></span></p>
              </div>
              <div class="col-md-6">
                <h6>Current Lease Status</h6>
                <p><strong>Status:</strong> <span id="modal-lease-status"></span></p>
                <p><strong>Days Remaining:</strong> <span id="modal-days-remaining"></span></p>
                <p><strong>Expiration Date:</strong> <span id="modal-expiration-date"></span></p>
                <p><strong>Renewals:</strong> <span id="modal-renewal-count"></span></p>
              </div>
            </div>
            
            <hr>
            
            <div class="row">
              <div class="col-md-6">
                <h6>Renew Lease</h6>
                <form id="renew-lease-form">
                  <input type="hidden" id="renew-client-id">
                  <div class="mb-3">
                    <label for="renew-duration" class="form-label">New Duration</label>
                    <select class="form-select" id="renew-duration" required>
                      <option value="7">7 Days</option>
                      <option value="14">14 Days</option>
                      <option value="30">30 Days</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-success w-100">
                    <span class="spinner-border spinner-border-sm d-none" id="renew-spinner"></span>
                    <i class="bi bi-arrow-clockwise"></i> Renew Lease
                  </button>
                </form>
              </div>
              <div class="col-md-6">
                <h6>Extend Current Lease</h6>
                <form id="extend-lease-form">
                  <input type="hidden" id="extend-client-id">
                  <div class="mb-3">
                    <label for="extend-days" class="form-label">Additional Days</label>
                    <input type="number" class="form-control" id="extend-days" min="1" max="90" required>
                  </div>
                  <button type="submit" class="btn btn-warning w-100">
                    <span class="spinner-border spinner-border-sm d-none" id="extend-spinner"></span>
                    <i class="bi bi-plus-circle"></i> Extend Lease
                  </button>
                </form>
              </div>
            </div>
            
            <hr>
            
            <div class="row">
              <div class="col-md-12">
                <h6>Lease History</h6>
                <div id="lease-history-container">
                  <div class="text-muted">Loading lease history...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editClientModalLabel">
              <i class="bi bi-pencil-square"></i> Edit Client
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="edit-client-form">
              <input type="hidden" id="edit-client-id">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit-client-name" class="form-label">Client Name</label>
                    <input type="text" class="form-control" id="edit-client-name" disabled>
                  </div>
                  <div class="mb-3">
                    <label for="edit-allowed-domains" class="form-label">Allowed Domains</label>
                    <input type="text" class="form-control" id="edit-allowed-domains">
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="edit-client-active">
                    <label class="form-check-label" for="edit-client-active">Active</label>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="edit-auto-renewal">
                    <label class="form-check-label" for="edit-auto-renewal">Auto Renewal</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit-primary-color" class="form-label">Primary Color</label>
                    <input type="color" class="form-control form-control-color" id="edit-primary-color" value="#0084ff">
                  </div>
                  <div class="mb-3">
                    <label for="edit-secondary-color" class="form-label">Secondary Color</label>
                    <input type="color" class="form-control form-control-color" id="edit-secondary-color" value="#ffffff">
                  </div>
                  <div class="mb-3">
                    <label for="edit-header-text" class="form-label">Header Text</label>
                    <input type="text" class="form-control" id="edit-header-text" value="Chat with us">
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-client-changes">
              <span class="spinner-border spinner-border-sm d-none" id="save-spinner"></span>
              <i class="bi bi-check-circle"></i> Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container">
    <div id="toast-notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-message">
        Action completed successfully.
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Configuration
    const API_BASE_URL = ''; // Your actual server URL
    const ADMIN_KEY = '12!Michael'; // The admin key from your .env file
    let clients = [];
    let currentClientId = '';
    let currentToken = '';
    let editClientModal;
    let leaseManagementModal;
    const toastEl = document.getElementById('toast-notification');
    let toast;

    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 10;
    let totalClients = 0;

    // Initialize components after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      toast = new bootstrap.Toast(toastEl);
      editClientModal = new bootstrap.Modal(document.getElementById('editClientModal'));
      leaseManagementModal = new bootstrap.Modal(document.getElementById('leaseManagementModal'));
      
      // Load lease dashboard stats
      loadLeaseStats();
      
      // Fetch clients on page load
      fetchClients(currentPage);
      
      // Set up filter event listeners
      setupFilterListeners();
    });

    // Setup filter event listeners
    function setupFilterListeners() {
      document.getElementById('lease-status-filter').addEventListener('change', function() {
        currentPage = 1;
        fetchClients(currentPage);
      });
      
      document.getElementById('duration-filter').addEventListener('change', function() {
        currentPage = 1;
        fetchClients(currentPage);
      });
    }



// ENHANCED CONNECTION TEST FUNCTION
async function testConnection() {
  try {
    console.log('Testing connection...');
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(`${API_BASE_URL}/api/health`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      console.log('Connection test successful:', data);
      showNotification('Success', 'Connection test successful', 'success');
      return true;
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  } catch (error) {
    console.error('Connection test failed:', error);
    
    let errorMessage = 'Connection test failed';
    if (error.name === 'AbortError') {
      errorMessage = 'Connection test timed out';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error - check your internet connection';
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    showNotification('Error', errorMessage, 'error');
    return false;
  }
}

// ENHANCED INITIALIZATION FUNCTION
async function initializeDashboard() {
  try {
    console.log('Initializing dashboard...');
    
    // Test connection first
    const connectionOk = await testConnection();
    
    if (!connectionOk) {
      console.warn('Connection test failed, but continuing with initialization...');
    }
    
    // Load dashboard data in parallel
    const promises = [
      loadLeaseStats(),
      fetchClients(currentPage)
    ];
    
    await Promise.allSettled(promises);
    
    console.log('Dashboard initialization complete');
    
  } catch (error) {
    console.error('Dashboard initialization error:', error);
    showNotification('Error', 'Failed to initialize dashboard', 'error');
  }
}

// ENHANCED ERROR RECOVERY FUNCTION
function recoverFromError() {
  console.log('Attempting error recovery...');
  showNotification('Info', 'Attempting to recover from error...', 'info');
  
  // Reset state
  clients = [];
  totalClients = 0;
  currentPage = 1;
  totalPages = 1;
  
  // Clear any existing error states
  const errorElements = document.querySelectorAll('.alert-danger');
  errorElements.forEach(el => el.remove());
  
  // Reinitialize
  setTimeout(() => {
    initializeDashboard();
  }, 1000);
}

// ENHANCED NETWORK STATUS MONITORING
window.addEventListener('online', function() {
  console.log('Network connection restored');
  showNotification('Connected', 'Internet connection restored', 'success');
  setTimeout(() => {
    initializeDashboard();
  }, 1000);
});

window.addEventListener('offline', function() {
  console.log('Network connection lost');
  showNotification('Offline', 'No internet connection', 'warning');
});

// Add retry functionality to the page
function addRetryButton() {
  const retryButton = document.createElement('button');
  retryButton.className = 'btn btn-primary btn-sm';
  retryButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry Loading';
  retryButton.onclick = recoverFromError;
  
  const pageHeader = document.querySelector('.page-header');
  if (pageHeader) {
    pageHeader.appendChild(retryButton);
  }
}

// ENHANCED ERROR NOTIFICATION WITH STACK TRACE (DEV ONLY)
function showDetailedError(error, context = '') {
  if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
    console.group(`Detailed Error: ${context}`);
    console.error('Error object:', error);
    console.error('Error stack:', error.stack);
    console.error('Error name:', error.name);
    console.error('Error message:', error.message);
    console.groupEnd();
  }
}

// Export functions for global access
window.fetchClients = fetchClients;
window.loadLeaseStats = loadLeaseStats;
window.testConnection = testConnection;
window.initializeDashboard = initializeDashboard;
window.recoverFromError = recoverFromError;

    // Load lease statistics


// ENHANCED LOAD LEASE STATS FUNCTION
async function loadLeaseStats() {
  try {
    console.log('=== LOADING LEASE STATS ===');
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000);
    
    const response = await fetch(`${API_BASE_URL}/api/clients/lease-dashboard`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'x-admin-key': ADMIN_KEY,
        'Cache-Control': 'no-cache'
      },
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    console.log('Lease stats response status:', response.status);
    
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (parseError) {
        const responseText = await response.text();
        console.error('Failed to parse lease stats error response:', parseError);
        console.error('Raw response:', responseText);
        throw new Error(`HTTP ${response.status}: Failed to load dashboard`);
      }
      
      console.error('Lease stats API error:', errorData);
      throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Lease stats loaded:', data);
    
    // Validate response structure
    if (!data || !data.stats) {
      throw new Error('Invalid dashboard response: missing stats');
    }
    
    // Update statistics cards with error handling
    const updateStat = (elementId, value, fallback = 0) => {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value !== undefined ? value : fallback;
      } else {
        console.warn(`Element not found: ${elementId}`);
      }
    };
    
    updateStat('active-leases-count', data.stats.leaseStatus?.active);
    updateStat('expiring-soon-count', data.stats.leaseStatus?.expiring3Days);
    updateStat('expired-count', data.stats.leaseStatus?.expired);
    updateStat('total-clients-count', data.stats.totalClients);
    
    console.log('=== LEASE STATS SUCCESS ===');
    
  } catch (error) {
    console.error('=== LEASE STATS ERROR ===');
    console.error('Error details:', error);
    
    let errorMessage = 'Failed to load dashboard statistics';
    
    if (error.name === 'AbortError') {
      errorMessage = 'Dashboard request timed out';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error loading dashboard';
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    showNotification('Warning', errorMessage, 'warning');
    
    // Set default values on error
    const defaultStats = ['active-leases-count', 'expiring-soon-count', 'expired-count', 'total-clients-count'];
    defaultStats.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = '?';
        element.style.color = '#dc3545'; // Red color to indicate error
      }
    });
  }
}

    // Show/hide loading spinners
    function toggleSpinner(elementId, show) {
      const spinner = document.getElementById(elementId);
      if (spinner) {
        if (show) {
          spinner.classList.remove('d-none');
        } else {
          spinner.classList.add('d-none');
        }
      }
    }

    // Show notification
    function showNotification(title, message, type = 'success') {
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-message').textContent = message;
      
      // Reset classes
      toastEl.className = 'toast';
      
      if (type === 'success') {
        toastEl.classList.add('bg-success', 'text-white');
      } else if (type === 'error') {
        toastEl.classList.add('bg-danger', 'text-white');
      } else if (type === 'warning') {
        toastEl.classList.add('bg-warning');
      }
      
      toast.show();
    }

    // Get lease status badge HTML
    function getLeaseStatusBadge(leaseStatus) {
      const statusMap = {
        'active': { class: 'lease-active', text: 'Active' },
        'expiring_soon': { class: 'lease-expiring', text: 'Expiring Soon' },
        'expired': { class: 'lease-expired', text: 'Expired' },
        'grace_period': { class: 'lease-grace', text: 'Grace Period' }
      };
      
      const status = statusMap[leaseStatus.status] || { class: 'bg-secondary', text: 'Unknown' };
      return `<span class="badge ${status.class} lease-status-badge">${status.text}</span>`;
    }

    // Get progress bar for days remaining
    function getDaysProgressBar(leaseStatus) {
      if (leaseStatus.status === 'expired') {
        return `<div class="progress-days"><div class="progress-fill expired" style="width: 100%"></div></div>`;
      }
      
      const totalDays = 30; // Assuming max 30 days for progress calculation
      const remaining = Math.max(0, leaseStatus.daysRemaining);
      const percentage = Math.min(100, (remaining / totalDays) * 100);
      
      let progressClass = 'active';
      if (remaining <= 3) progressClass = 'expiring';
      if (remaining <= 0) progressClass = 'expired';
      
      return `<div class="progress-days"><div class="progress-fill ${progressClass}" style="width: ${percentage}%"></div></div>`;
    }

    // Fetch clients with enhanced lease filtering
// ENHANCED FETCH CLIENTS FUNCTION WITH COMPREHENSIVE ERROR HANDLING
async function fetchClients(page = 1, limit = pageSize) {
  try {
    console.log('=== FETCH CLIENTS START ===');
    console.log('Page:', page, 'Limit:', limit);
    
    document.getElementById('clients-loading').style.display = 'flex';
    toggleSpinner('refresh-spinner', true);
    
    // Build query parameters with validation
    const params = new URLSearchParams({
      page: Math.max(1, page),
      limit: Math.min(Math.max(1, limit), 100),
      sortBy: 'leaseConfig.expirationDate',
      sortOrder: 'asc'
    });
    
    // Add filters with validation
    const leaseStatusFilter = document.getElementById('lease-status-filter')?.value;
    const durationFilter = document.getElementById('duration-filter')?.value;
    
    if (leaseStatusFilter) params.append('leaseStatus', leaseStatusFilter);
    if (durationFilter) params.append('leaseDuration', durationFilter);
    
    console.log('Request URL:', `${API_BASE_URL}/api/clients?${params}`);
    console.log('Admin Key Set:', !!ADMIN_KEY);
    
    // Enhanced fetch with timeout and comprehensive error handling
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      controller.abort();
    }, 30000); // 30 second timeout
    
    const response = await fetch(`${API_BASE_URL}/api/clients?${params}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'x-admin-key': ADMIN_KEY,
        'Cache-Control': 'no-cache'
      },
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    console.log('Response status:', response.status);
    console.log('Response headers:', Object.fromEntries(response.headers.entries()));
    
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (parseError) {
        const responseText = await response.text();
        console.error('Failed to parse error response as JSON:', parseError);
        console.error('Raw response:', responseText);
        
        throw new Error(`HTTP ${response.status}: ${response.statusText || 'Unknown error'}`);
      }
      
      console.error('API Error Response:', errorData);
      
      // Handle specific error cases
      if (response.status === 401) {
        throw new Error('Authentication failed. Please check your admin key.');
      } else if (response.status === 403) {
        throw new Error('Access denied. You do not have permission to view clients.');
      } else if (response.status === 500) {
        throw new Error(errorData.message || 'Server error occurred while fetching clients.');
      } else {
        throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
      }
    }
    
    const data = await response.json();
    console.log('Response data structure:', {
      hasClients: !!data.clients,
      clientsCount: data.clients?.length || 0,
      hasPagination: !!data.pagination,
      hasStats: !!data.stats
    });
    
    // Validate response structure
    if (!data || typeof data !== 'object') {
      throw new Error('Invalid response format: expected object');
    }
    
    if (!Array.isArray(data.clients)) {
      console.warn('Invalid clients data:', data.clients);
      throw new Error('Invalid response format: clients must be an array');
    }
    
    // Set global variables with fallbacks
    clients = data.clients || [];
    totalClients = data.pagination?.total || 0;
    totalPages = data.pagination?.pages || 1;
    currentPage = data.pagination?.page || 1;
    
    console.log('Data processed successfully:', {
      clientsLoaded: clients.length,
      totalClients,
      currentPage,
      totalPages
    });
    
    // Update UI components
    updateClientsList();
    updateClientDropdown();
    updatePagination();
    
    // Update client count badge
    const countBadge = document.getElementById('client-count-badge');
    if (countBadge) {
      countBadge.textContent = `${totalClients} clients`;
    }
    
    // Update stats if available
    if (data.stats) {
      const activeCountEl = document.getElementById('active-leases-count');
      const expiredCountEl = document.getElementById('expired-count');
      const totalCountEl = document.getElementById('total-clients-count');
      
      if (activeCountEl) activeCountEl.textContent = data.stats.totalActive || 0;
      if (expiredCountEl) expiredCountEl.textContent = data.stats.totalExpired || 0;
      if (totalCountEl) totalCountEl.textContent = data.stats.totalClients || 0;
    }
    
    console.log('=== FETCH CLIENTS SUCCESS ===');
    showNotification('Success', 'Clients loaded successfully');
    
  } catch (error) {
    console.error('=== FETCH CLIENTS ERROR ===');
    console.error('Error details:', error);
    console.error('Error stack:', error.stack);
    
    // Handle specific error types
    let errorMessage = 'Failed to load clients';
    
    if (error.name === 'AbortError') {
      errorMessage = 'Request timed out. Please check your connection and try again.';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network error. Please check your internet connection.';
    } else if (error.message.includes('Authentication failed')) {
      errorMessage = 'Authentication failed. Please refresh the page and try again.';
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    showNotification('Error', errorMessage, 'error');
    
    // Set empty state with error information
    clients = [];
    totalClients = 0;
    totalPages = 1;
    currentPage = 1;
    
    // Update UI to show error state
    updateClientsList();
    updateClientDropdown();
    updatePagination();
    
    // Show error details in client list
    const clientList = document.getElementById('client-list');
    const clientCards = document.getElementById('client-cards');
    
    if (clientList) {
      clientList.innerHTML = `
        <tr>
          <td colspan="9" class="text-center py-4">
            <div class="alert alert-danger">
              <h5>Failed to Load Clients</h5>
              <p>${errorMessage}</p>
              <button class="btn btn-outline-danger btn-sm" onclick="fetchClients(1)">
                <i class="bi bi-arrow-clockwise"></i> Retry
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    if (clientCards) {
      clientCards.innerHTML = `
        <div class="client-card text-center py-4">
          <div class="alert alert-danger">
            <h5>Failed to Load Clients</h5>
            <p>${errorMessage}</p>
            <button class="btn btn-outline-danger btn-sm" onclick="fetchClients(1)">
              <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
          </div>
        </div>
      `;
    }
    
    // Update badges to show error state
    const badges = ['active-leases-count', 'expired-count', 'total-clients-count', 'client-count-badge'];
    badges.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = id === 'client-count-badge' ? 'Error' : '?';
      }
    });
    
  } finally {
    // Always hide loading indicators
    const loadingEl = document.getElementById('clients-loading');
    if (loadingEl) {
      loadingEl.style.display = 'none';
    }
    toggleSpinner('refresh-spinner', false);
    
    console.log('=== FETCH CLIENTS COMPLETE ===');
  }
}

    // Update clients list with lease information
    function updateClientsList() {
      const clientList = document.getElementById('client-list');
      const clientCards = document.getElementById('client-cards');
      
      // Clear both desktop and mobile views
      clientList.innerHTML = '';
      clientCards.innerHTML = '';
      
      if (clients.length === 0) {
        // Desktop empty state
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="9" class="text-center py-4">No clients found. Create your first client to get started.</td>';
        clientList.appendChild(row);
        
        // Mobile empty state
        const card = document.createElement('div');
        card.className = 'client-card text-center py-4';
        card.innerHTML = '<p class="mb-0">No clients found. Create your first client to get started.</p>';
        clientCards.appendChild(card);
        return;
      }
      
      clients.forEach(client => {
        const leaseStatus = client.leaseStatus || { status: 'unknown', daysRemaining: 0 };
        const leaseInfo = client.leaseInfo || {};
        
        // Desktop table row
        const row = document.createElement('tr');
        row.className = 'client-row';
        
        row.innerHTML = `
          <td class="copyable" onclick="copyToClipboard('${client.clientId}')" title="Click to copy">${client.clientId}</td>
          <td>${client.name}</td>
          <td>${client.email}</td>
          <td>${getLeaseStatusBadge(leaseStatus)}</td>
          <td>
            <div>${leaseStatus.daysRemaining >= 0 ? leaseStatus.daysRemaining : 'Expired'}</div>
            ${getDaysProgressBar(leaseStatus)}
          </td>
          <td>${leaseInfo.duration || 'N/A'} days</td>
          <td>${leaseInfo.renewalCount || 0}</td>
          <td>${client.requestCount || 0}</td>
          <td>
            <div class="lease-actions">
              <button class="btn btn-sm btn-outline-primary edit-client" data-client-id="${client.clientId}" title="Edit Client">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-success manage-lease" data-client-id="${client.clientId}" title="Manage Lease">
                <i class="bi bi-calendar-check"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning ${client.active ? 'deactivate-client' : 'activate-client'}" 
                      data-client-id="${client.clientId}" title="${client.active ? 'Deactivate' : 'Activate'}">
                <i class="bi bi-${client.active ? 'pause' : 'play'}-circle"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger delete-client" data-client-id="${client.clientId}" title="Delete Client">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        clientList.appendChild(row);
        
        // Mobile card view
        const card = document.createElement('div');
        card.className = `client-card ${leaseStatus.status === 'expired' ? 'lease-expired' : 
                                       leaseStatus.status === 'expiring_soon' ? 'lease-expiring' : 
                                       leaseStatus.status === 'grace_period' ? 'lease-grace' : 'lease-active'}`;
        
        card.innerHTML = `
          <div class="client-card-header">
            <div>
              <div class="client-card-title">${client.name}</div>
              <div class="client-card-id copyable" onclick="copyToClipboard('${client.clientId}')">${client.clientId}</div>
            </div>
            ${getLeaseStatusBadge(leaseStatus)}
          </div>
          <div class="client-card-body">
            <div class="client-card-info">
              <div class="client-card-info-item">
                <div class="client-card-info-label">Email</div>
                <div class="client-card-info-value">${client.email}</div>
              </div>
              <div class="client-card-info-item">
                <div class="client-card-info-label">Days Left</div>
                <div class="client-card-info-value">${leaseStatus.daysRemaining >= 0 ? leaseStatus.daysRemaining : 'Expired'}</div>
              </div>
              <div class="client-card-info-item">
                <div class="client-card-info-label">Duration</div>
                <div class="client-card-info-value">${leaseInfo.duration || 'N/A'} days</div>
              </div>
              <div class="client-card-info-item">
                <div class="client-card-info-label">Requests</div>
                <div class="client-card-info-value">${client.requestCount || 0}</div>
              </div>
            </div>
            ${getDaysProgressBar(leaseStatus)}
          </div>
          <div class="client-card-actions">
            <button class="btn btn-sm btn-outline-primary edit-client" data-client-id="${client.clientId}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-success manage-lease" data-client-id="${client.clientId}">
              <i class="bi bi-calendar-check"></i> Lease
            </button>
            <button class="btn btn-sm btn-outline-warning ${client.active ? 'deactivate-client' : 'activate-client'}" 
                    data-client-id="${client.clientId}">
              <i class="bi bi-${client.active ? 'pause' : 'play'}-circle"></i> ${client.active ? 'Pause' : 'Activate'}
            </button>
            <button class="btn btn-sm btn-outline-danger delete-client" data-client-id="${client.clientId}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        `;
        
        clientCards.appendChild(card);
      });
      
      // Add event listeners to both desktop and mobile elements
      document.querySelectorAll('.edit-client').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          openEditClientModal(clientId);
        });
      });
      
      document.querySelectorAll('.manage-lease').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          openLeaseManagementModal(clientId);
        });
      });
      
      document.querySelectorAll('.activate-client, .deactivate-client').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          const activate = this.classList.contains('activate-client');
          toggleClientStatus(clientId, activate, this);
        });
      });
      
      document.querySelectorAll('.delete-client').forEach(btn => {
        btn.addEventListener('click', function() {
          const clientId = this.getAttribute('data-client-id');
          deleteClient(clientId, this);
        });
      });
    }

    // Update client dropdown in the token generation form
    function updateClientDropdown() {
      const dropdown = document.getElementById('token-client-id');
      dropdown.innerHTML = '<option value="" selected disabled>Select a client</option>';
      
      const activeClients = clients.filter(client => client.active && client.leaseStatus && client.leaseStatus.status !== 'expired');
      
      if (activeClients.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "No active clients with valid leases";
        option.disabled = true;
        dropdown.appendChild(option);
        return;
      }
      
      activeClients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.clientId;
        const leaseInfo = client.leaseStatus ? ` (${client.leaseStatus.daysRemaining} days left)` : '';
        option.textContent = `${client.name} (${client.clientId})${leaseInfo}`;
        dropdown.appendChild(option);
      });
    }

    // Update pagination display and controls
    function updatePagination() {
      const startIndex = (currentPage - 1) * pageSize + 1;
      const endIndex = Math.min(currentPage * pageSize, totalClients);
      
      document.getElementById('start-index').textContent = totalClients > 0 ? startIndex : 0;
      document.getElementById('end-index').textContent = endIndex;
      document.getElementById('total-clients').textContent = totalClients;
      
      const paginationControls = document.getElementById('pagination-controls');
      paginationControls.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-link';
      prevBtn.innerHTML = '&laquo;';
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          fetchClients(currentPage - 1);
        }
      });
      prevLi.appendChild(prevBtn);
      paginationControls.appendChild(prevLi);
      
      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        const pageBtn = document.createElement('button');
        pageBtn.className = 'page-link';
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
          if (i !== currentPage) {
            fetchClients(i);
          }
        });
        pageLi.appendChild(pageBtn);
        paginationControls.appendChild(pageLi);
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-link';
      nextBtn.innerHTML = '&raquo;';
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          fetchClients(currentPage + 1);
        }
      });
      nextLi.appendChild(nextBtn);
      paginationControls.appendChild(nextLi);
    }

    // Open lease management modal
    async function openLeaseManagementModal(clientId) {
      const client = clients.find(c => c.clientId === clientId);
      if (!client) return;
      
      const leaseStatus = client.leaseStatus || {};
      const leaseInfo = client.leaseInfo || {};
      
      // Populate modal with client and lease information
      document.getElementById('modal-client-name').textContent = client.name;
      document.getElementById('modal-client-email').textContent = client.email;
      document.getElementById('modal-client-id').textContent = client.clientId;
      document.getElementById('modal-lease-status').innerHTML = getLeaseStatusBadge(leaseStatus);
      document.getElementById('modal-days-remaining').textContent = leaseStatus.daysRemaining >= 0 ? leaseStatus.daysRemaining : 'Expired';
      document.getElementById('modal-expiration-date').textContent = leaseInfo.expirationDate ? new Date(leaseInfo.expirationDate).toLocaleDateString() : 'N/A';
      document.getElementById('modal-renewal-count').textContent = leaseInfo.renewalCount || 0;
      
      // Set form values
      document.getElementById('renew-client-id').value = clientId;
      document.getElementById('extend-client-id').value = clientId;
      
      // Load lease history
      await loadLeaseHistory(clientId);
      
      leaseManagementModal.show();
    }

    // Load lease history for a client
    async function loadLeaseHistory(clientId) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients/${clientId}/lease-history`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          }
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        const historyContainer = document.getElementById('lease-history-container');
        
        if (data.leaseHistory && data.leaseHistory.length > 0) {
          let historyHtml = '<div class="table-responsive"><table class="table table-sm">';
          historyHtml += '<thead><tr><th>Start Date</th><th>End Date</th><th>Duration</th><th>Type</th><th>Renewed By</th></tr></thead><tbody>';
          
          data.leaseHistory.forEach(lease => {
            historyHtml += `
              <tr>
                <td>${new Date(lease.startDate).toLocaleDateString()}</td>
                <td>${new Date(lease.endDate).toLocaleDateString()}</td>
                <td>${lease.duration} days</td>
                <td><span class="badge bg-secondary">${lease.renewalType}</span></td>
                <td>${lease.renewedBy || 'N/A'}</td>
              </tr>
            `;
          });
          
          historyHtml += '</tbody></table></div>';
          historyContainer.innerHTML = historyHtml;
        } else {
          historyContainer.innerHTML = '<div class="text-muted">No lease history available.</div>';
        }
      } catch (error) {
        console.error('Error loading lease history:', error);
        document.getElementById('lease-history-container').innerHTML = '<div class="text-danger">Failed to load lease history.</div>';
      }
    }

    // Create client form with lease duration
    document.getElementById('create-client-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('client-name').value.trim();
      const email = document.getElementById('client-email').value.trim();
      const leaseDuration = parseInt(document.getElementById('lease-duration').value);
      const allowedDomainsStr = document.getElementById('allowed-domains').value.trim();
      const widgetId = "6809b3a1523186af0b2c9933";
      
      let allowedDomains = [];
      if (allowedDomainsStr) {
        allowedDomains = allowedDomainsStr.split(',').map(domain => domain.trim());
      }
      
      toggleSpinner('create-spinner', true);
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            name,
            email,
            allowedDomains,
            widgetId,
            leaseDuration,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Reset form
        document.getElementById('create-client-form').reset();
        document.getElementById('lease-duration').value = '30'; // Reset to default
        
        // Refresh client list and stats
        await fetchClients(1);
        await loadLeaseStats();
        
        showNotification('Success', `Client created successfully with ${leaseDuration}-day lease`);
        
      } catch (error) {
        console.error('Error creating client:', error);
        showNotification('Error', 'Failed to create client: ' + error.message, 'error');
      } finally {
        toggleSpinner('create-spinner', false);
      }
    });

    // Generate token for client
    document.getElementById('generate-token-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientId = document.getElementById('token-client-id').value;
      if (!clientId) {
        showNotification('Error', 'Please select a client', 'error');
        return;
      }
      
      toggleSpinner('token-spinner', true);
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            clientId,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
  
        currentClientId = clientId;
        currentToken = data.token;
        
        document.getElementById('token-display').textContent = data.token;
        document.getElementById('token-result').style.display = 'block';
        
        showNotification('Success', 'Token generated successfully');
      } catch (error) {
        console.error('Error generating token:', error);
        showNotification('Error', 'Failed to generate token: ' + error.message, 'error');
      } finally {
        toggleSpinner('token-spinner', false);
      }
    });

    // Copy token to clipboard
    document.getElementById('copy-token').addEventListener('click', function() {
      navigator.clipboard.writeText(currentToken)
        .then(() => {
          showNotification('Copied', 'Token copied to clipboard');
        })
        .catch(err => {
          console.error('Failed to copy token:', err);
          showNotification('Error', 'Failed to copy to clipboard', 'error');
        });
    });

    // Copy embed code to clipboard
    document.getElementById('copy-embed-code').addEventListener('click', function() {
      const serverUrl = API_BASE_URL || 'https://chatbott-5579.onrender.com';
      const embedCode = `<script src="${serverUrl}/widget.js"><\/script>
<script>
  window.MyChatWidget.init({
    token: "${currentToken}",
    clientId: "${currentClientId}"
  });
<\/script>`;
      
      navigator.clipboard.writeText(embedCode)
        .then(() => {
          showNotification('Copied', 'Embed code copied to clipboard');
        })
        .catch(err => {
          console.error('Failed to copy embed code:', err);
          showNotification('Error', 'Failed to copy to clipboard', 'error');
        });
    });

    // Refresh clients list
    document.getElementById('refresh-clients').addEventListener('click', function() {
      fetchClients(currentPage);
      loadLeaseStats();
    });

    // Expire clients button handler
    document.getElementById('expire-clients-btn').addEventListener('click', async function() {
      if (!confirm('Are you sure you want to expire all overdue clients? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/lease/expire-clients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Refresh client list and stats
        await fetchClients(currentPage);
        await loadLeaseStats();
        
        showNotification('Success', `Expired ${data.results.expired} clients out of ${data.results.processed} processed`);
        
      } catch (error) {
        console.error('Error expiring clients:', error);
        showNotification('Error', 'Failed to expire clients: ' + error.message, 'error');
      }
    });

    // Renew lease form handler
    document.getElementById('renew-lease-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientId = document.getElementById('renew-client-id').value;
      const duration = parseInt(document.getElementById('renew-duration').value);
      
      toggleSpinner('renew-spinner', true);
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients/${clientId}/renew-lease`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            duration: duration,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Refresh client list and close modal
        await fetchClients(currentPage);
        leaseManagementModal.hide();
        
        showNotification('Success', `Lease renewed successfully for ${duration} days`);
        
      } catch (error) {
        console.error('Error renewing lease:', error);
        showNotification('Error', 'Failed to renew lease: ' + error.message, 'error');
      } finally {
        toggleSpinner('renew-spinner', false);
      }
    });

    // Extend lease form handler
    document.getElementById('extend-lease-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientId = document.getElementById('extend-client-id').value;
      const additionalDays = parseInt(document.getElementById('extend-days').value);
      
      toggleSpinner('extend-spinner', true);
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients/${clientId}/extend-lease`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            additionalDays: additionalDays,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Refresh client list and close modal
        await fetchClients(currentPage);
        leaseManagementModal.hide();
        
        showNotification('Success', `Lease extended by ${additionalDays} days`);
        
      } catch (error) {
        console.error('Error extending lease:', error);
        showNotification('Error', 'Failed to extend lease: ' + error.message, 'error');
      } finally {
        toggleSpinner('extend-spinner', false);
      }
    });

    // Open edit client modal
    function openEditClientModal(clientId) {
      const client = clients.find(c => c.clientId === clientId);
      if (!client) return;
      
      document.getElementById('edit-client-id').value = client.clientId;
      document.getElementById('edit-client-name').value = client.name;
      document.getElementById('edit-allowed-domains').value = client.allowedDomains ? client.allowedDomains.join(', ') : '';
      document.getElementById('edit-client-active').checked = client.active;
      document.getElementById('edit-auto-renewal').checked = client.leaseInfo?.autoRenewal || false;
      
      const customization = client.chatbotConfig?.customization || {};
      document.getElementById('edit-primary-color').value = customization.primaryColor || '#0084ff';
      document.getElementById('edit-secondary-color').value = customization.secondaryColor || '#ffffff';
      document.getElementById('edit-header-text').value = customization.headerText || 'Chat with us';
      
      editClientModal.show();
    }

    // Save client changes
    document.getElementById('save-client-changes').addEventListener('click', async function() {
      const clientId = document.getElementById('edit-client-id').value;
      const allowedDomainsStr = document.getElementById('edit-allowed-domains').value.trim();
      const active = document.getElementById('edit-client-active').checked;
      const autoRenewal = document.getElementById('edit-auto-renewal').checked;
      
      let allowedDomains = [];
      if (allowedDomainsStr) {
        allowedDomains = allowedDomainsStr.split(',').map(domain => domain.trim());
      }
      
      const customization = {
        primaryColor: document.getElementById('edit-primary-color').value,
        secondaryColor: document.getElementById('edit-secondary-color').value,
        headerText: document.getElementById('edit-header-text').value.trim()
      };
      
      toggleSpinner('save-spinner', true);
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients/${clientId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            active,
            allowedDomains,
            customization,
            autoRenewal,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        await fetchClients(currentPage);
        editClientModal.hide();
        showNotification('Success', 'Client updated successfully');
      } catch (error) {
        console.error('Error updating client:', error);
        showNotification('Error', 'Failed to update client: ' + error.message, 'error');
      } finally {
        toggleSpinner('save-spinner', false);
      }
    });

    // Toggle client status
    async function toggleClientStatus(clientId, activate, buttonElement) {
      if (buttonElement) {
        buttonElement.disabled = true;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients/${clientId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          },
          body: JSON.stringify({
            active: activate,
            adminKey: ADMIN_KEY
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        await fetchClients(currentPage);
        await loadLeaseStats();
        
        showNotification('Success', `Client ${activate ? 'activated' : 'deactivated'} successfully`);
      } catch (error) {
        console.error('Error toggling client status:', error);
        showNotification('Error', 'Failed to update client status: ' + error.message, 'error');
      } finally {
        if (buttonElement) {
          buttonElement.disabled = false;
        }
      }
    }
    
    // Delete client function
    async function deleteClient(clientId, buttonElement) {
      if (!confirm(`Are you sure you want to permanently delete client ${clientId}? This action cannot be undone.`)) {
        return;
      }
      
      if (buttonElement) {
        buttonElement.disabled = true;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/clients/${clientId}?confirm=true`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': ADMIN_KEY
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }
        
        const shouldGoBack = clients.length === 1 && currentPage > 1;
        
        await fetchClients(shouldGoBack ? currentPage - 1 : currentPage);
        await loadLeaseStats();
        
        showNotification('Success', 'Client deleted successfully');
      } catch (error) {
        console.error('Error deleting client:', error);
        showNotification('Error', 'Failed to delete client: ' + error.message, 'error');
      } finally {
        if (buttonElement) {
          buttonElement.disabled = false;
        }
      }
    }

    // Helper function to copy text to clipboard
    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          showNotification('Copied', 'Copied to clipboard');
        })
        .catch(err => {
          console.error('Failed to copy:', err);
          showNotification('Error', 'Failed to copy to clipboard', 'error');
        });
    };

    // Auto-refresh lease stats every 5 minutes
    setInterval(loadLeaseStats, 5 * 60 * 1000);
    
    // Auto-refresh client list every 2 minutes to catch lease status changes
    setInterval(() => {
      fetchClients(currentPage);
    }, 2 * 60 * 1000);

    // Handle window resize for responsive updates
    window.addEventListener('resize', function() {
      // Update table scroll indicators on resize
      const tableResponsive = document.querySelector('.table-responsive');
      if (tableResponsive) {
        const table = tableResponsive.querySelector('table');
        if (table && table.scrollWidth > tableResponsive.clientWidth) {
          tableResponsive.classList.add('scroll-indicator');
        } else {
          tableResponsive.classList.remove('scroll-indicator');
        }
      }
    });

    // Add touch support for mobile
    if ('ontouchstart' in window) {
      document.body.classList.add('touch-device');
      
      // Add touch feedback for buttons
      document.addEventListener('touchstart', function(e) {
        if (e.target.classList.contains('btn')) {
          e.target.style.transform = 'scale(0.95)';
        }
      });
      
      document.addEventListener('touchend', function(e) {
        if (e.target.classList.contains('btn')) {
          setTimeout(() => {
            e.target.style.transform = '';
          }, 100);
        }
      });
    }

    // Enhanced error handling for network issues
    window.addEventListener('online', function() {
      showNotification('Connected', 'Internet connection restored', 'success');
      // Refresh data when connection is restored
      setTimeout(() => {
        fetchClients(currentPage);
        loadLeaseStats();
      }, 1000);
    });

    window.addEventListener('offline', function() {
      showNotification('Offline', 'No internet connection', 'warning');
    });

    // Add keyboard shortcuts for power users
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + R for refresh
      if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        fetchClients(currentPage);
        loadLeaseStats();
        showNotification('Refreshed', 'Data refreshed manually');
      }
      
      // Escape to close modals
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
          const modalInstance = bootstrap.Modal.getInstance(modal);
          if (modalInstance) {
            modalInstance.hide();
          }
        });
      }
    });

    // Initialize accessibility features
    function initializeAccessibility() {
      // Add ARIA labels to interactive elements
      document.querySelectorAll('.copyable').forEach(element => {
        element.setAttribute('role', 'button');
        element.setAttribute('tabindex', '0');
        element.setAttribute('aria-label', 'Click to copy to clipboard');
        
        // Add keyboard support
        element.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });
      });
      
      // Add screen reader announcements for dynamic content
      const liveRegion = document.createElement('div');
      liveRegion.setAttribute('aria-live', 'polite');
      liveRegion.setAttribute('aria-atomic', 'true');
      liveRegion.className = 'sr-only';
      liveRegion.id = 'live-region';
      document.body.appendChild(liveRegion);
    }

    // Announce updates to screen readers
    function announceToScreenReader(message) {
      const liveRegion = document.getElementById('live-region');
      if (liveRegion) {
        liveRegion.textContent = message;
        setTimeout(() => {
          liveRegion.textContent = '';
        }, 1000);
      }
    }

    // Initialize accessibility features when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeAccessibility);

    // Add loading states for better UX
    function setLoadingState(isLoading) {
      const buttons = document.querySelectorAll('.btn:not(.btn-close)');
      const inputs = document.querySelectorAll('.form-control, .form-select');
      
      buttons.forEach(btn => {
        btn.disabled = isLoading;
        if (isLoading) {
          btn.classList.add('loading');
        } else {
          btn.classList.remove('loading');
        }
      });
      
      inputs.forEach(input => {
        input.disabled = isLoading;
      });
    }

    // Enhanced console logging for debugging
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
      console.log('Chatbot Lease Management Dashboard Debug Mode');
      console.log('API Base URL:', API_BASE_URL || 'Same origin');
      console.log('Admin Key Set:', !!ADMIN_KEY);
      
      // Add debug utilities to window object
      window.debugDashboard = {
        fetchClients: () => fetchClients(currentPage),
        loadStats: loadLeaseStats,
        getCurrentClients: () => clients,
        getConfig: () => ({
          currentPage,
          totalPages,
          pageSize,
          totalClients,
          API_BASE_URL
        })
      };
    }
  </script>
</body>
</html>